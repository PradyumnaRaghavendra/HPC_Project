# RAGEN Configuration - Optimized Based on Paper Findings

model:
  name: "Qwen/Qwen2.5-3B-Instruct"  # Full 3B model for Modal H100
  ref_model: "Qwen/Qwen2.5-3B-Instruct"
  max_length: 2048
  sft_max_length: 512
  device: "cuda"

apo:
  beta: 0.5
  v_star_samples: 2
  adaptive_vstar: true
  learning_rate: 0.00001  # ← 10x higher than TinyZero (multi-turn needs stronger signal)
  batch_size: 4  # ← Minimum 4 for stable advantage normalization
  gradient_accumulation_steps: 8
  kl_coef: 0.02  # ← RAGEN paper uses 0.02 for KL regularization
  adv_clip: 2.0
  clip_grad_norm: 1.0
  weighting_scheme: "exp"  # ← Use exponential weighting like RAGEN
  adaptive_clip: false

sampling:
  # Generation settings (RAGEN page 22)
  temperature: 0.8  # ← Increased from 0.5 for better exploration (finding click actions)
  top_p: 0.9
  top_k: 0
  use_min_new_tokens: false  # ← Disabled to avoid generation issues
  min_new_tokens: 10

training:
  num_epochs: 4  # ← 100 samples / batch_size 4 = 25 steps per epoch → need 4 epochs for 100 steps
  max_steps: 100  # ← Full training: 100 steps on H100
  eval_every: 20  # ← Evaluate every 20 steps
  save_every: 20  # ← Save checkpoints every 20 steps

environment:
  type: "webshop"
  max_turns: 5  # ← RAGEN uses 5 turns for WebShop
  num_products: 100  # ← WebShop only supports 100/500/1000 (pre-built indexes)

# Curriculum Learning (Option C) - Disabled (WebShop doesn't support custom product counts)
curriculum:
  enabled: false
  start_products: 10      # Start with 10 products (easy)
  target_products: 100    # End with 100 products (hard)
  success_threshold: 0.3  # Increase difficulty when >30% success
  check_every: 10         # Check success rate every 10 steps
  stages:
    - products: 10
      threshold: 0.3
    - products: 25
      threshold: 0.4
    - products: 50
      threshold: 0.4
    - products: 100
      threshold: 0.5

data:
  train_size: 100  # ← Full dataset for training
  eval_size: 25  # ← Reasonable eval set

logging:
  use_wandb: false
  log_every: 5

seed: 42

# Uncertainty filtering config (StarPO-S)
uncertainty_filtering:
  enabled: true
  keep_percent: 0.50  # Keep top 50% high-variance prompts
  start_step: 30  # Start filtering after warm-up (30 steps)